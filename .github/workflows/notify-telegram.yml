name: Notify Telegram on Release

on:
  release:
    types: [published]

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram Notification (filtered)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}
        run: |
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–ª–æ —Ä–µ–ª–∏–∑–∞ –≤ —Ñ–∞–π–ª
          echo '${{ github.event.release.body }}' > release_body_raw.txt

          # –§–∏–ª—å—Ç—Ä—É–µ–º HTML-—Ç–µ–≥–∏ (—É–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å <...>)
          RELEASE_BODY=$(grep -vP '<.*?>' release_body_raw.txt || true)

          # –ï—Å–ª–∏ –ø—É—Å—Ç–æ, –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ-–∑–∞–≥–ª—É—à–∫—É
          if [ -z "$RELEASE_BODY" ]; then
            RELEASE_BODY="No change log text provided."
          fi

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å Markdown-—Ä–∞–∑–º–µ—Ç–∫–æ–π
          MSG="üöÄ *Project:* [${{ github.repository }}](https://github.com/${{ github.repository }})
üõ†Ô∏è *Release:* ${{ github.event.release.tag_name }}
üìù *Message:*
$RELEASE_BODY

üë§ Released by: \`${{ github.event.release.author.login }}\`"

          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d message_thread_id="${TELEGRAM_TOPIC_ID}" \
            -d parse_mode="MarkdownV2" \
            --data-urlencode text="$MSG"
